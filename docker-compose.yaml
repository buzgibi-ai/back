# version: '3.7'
services:

  db:
    image: postgres:latest
    container_name: buzgibi-db
    restart: 'always'
    ports:
      - 5432:5432
    environment:
      - DB_USER=${DBUSER}
      - DB_PASSWORD=3190d261d186aeead3a8deec202737c7775af5c8d455a9e5ba958c48b5fd3f59
      - DB_DATABASE=${DATABASE}
      - POSTGRES_PASSWORD=264c0424e4bd463a7d02b9db6896143e1a96cd1c52511119f839d2bc9c934241
      - POSTGRES_USER=postgres
    volumes:
      - ${PWD}/deploy/db/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d/
      - pg_db:/var/lib/postgresql/data
    networks:
      buzgibi:
         ipv4_address: 192.168.22.4

  back:
    image: europe-west3-docker.pkg.dev/buzgibi/back/back:${BACK_TAG}
    container_name: buzgibi-back
    links:
      - db
      - storage
    depends_on:
      - db
      - storage
      - migration
      - proxy-server
    ports:
      - 12000:12000
    volumes:
      - ${HOME}/env.yaml:/server/env.yaml
      - ${PWD}/deploy/init.sh:/server/deploy/init.sh
    networks:
      buzgibi:
         ipv4_address: 192.168.22.6

  front:
    image: europe-west3-docker.pkg.dev/buzgibi/front/front:${FRONT_TAG}
    container_name: buzgibi-front
    restart: 'always'
    ports:
      - 3001:3000
    networks:
      buzgibi:
        ipv4_address: 192.168.22.7

  storage:
    image: minio/minio:latest
    container_name: buzgibi-file-storage
    restart: 'always'
    ports:
      - 9001:9001
      - 9000:9000
    volumes:
      - minio_data:/data
    environment:
      MINIO_ROOT_USER: sonny
      MINIO_ROOT_PASSWORD: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
    command: server --address ":9000" --console-address ":9001" /data
    networks:
      buzgibi:
         ipv4_address: 192.168.22.5

  migration:
    image: liquibase/liquibase:latest
    container_name: buzgibi-migration
    depends_on:
      - db
      - storage
    volumes:
      - ${PWD}/migration/:/liquibase/changelog
      - ${PWD}/migration/liquibase_policy_init.sh:/liquibase/liquibase_policy_init.sh
    command: ['./liquibase_policy_init.sh']
    networks:
      - buzgibi

  proxy-server:
    image: nginx
    container_name: buzgibi-proxy-server
    volumes:
      - ${PWD}/deploy/nginx/proxy.conf:/etc/nginx/nginx.conf
      - ${HOME}/.htpasswd:/etc/apache2/.htpasswd
      - ${PWD}/deploy/nginx/ssl/front/buzgibi.crt:/etc/nginx/certs/front/buzgibi.crt
      - ${PWD}/deploy/nginx/ssl/front/buzgibi.key:/etc/nginx/certs/front/buzgibi.key
      - ${PWD}/deploy/nginx/ssl/back/buzgibi.crt:/etc/nginx/certs/back/buzgibi.crt
      - ${PWD}/deploy/nginx/ssl/back/buzgibi.key:/etc/nginx/certs/back/buzgibi.key
      - ${PWD}/deploy/nginx/ssl/global.pass:/etc/keys/global.pass
    ports:
      - 443:443
      - 80:80
    networks:
      - buzgibi

volumes:
  pg_db: {}
  minio_data: {}

networks:
  buzgibi:
    driver: bridge
    ipam:
     config:
       - subnet: 192.168.22.0/25
# vim: et:sw=2